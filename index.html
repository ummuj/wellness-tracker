<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness Dashboard & Daily Tracker (Local Storage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library for generating image snapshots of HTML content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --c-dark-blue: #0A2463;
            --c-mid-blue: #3E92CC;
            --c-bright-red: #D8315B;
            --c-green: #3DCC7B;
            --c-white: #FFFFFF;
            --c-light-gray: #f9fafb; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--c-light-gray);
            color: var(--c-dark-blue);
        }
        .header {
            background-color: var(--c-dark-blue);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .nav-link {
            color: var(--c-white);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .nav-link:hover {
            background-color: var(--c-mid-blue);
        }
        .nav-link.active {
            background-color: var(--c-mid-blue);
            font-weight: 600;
        }
        .card {
            background-color: var(--c-white);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background-color: var(--c-dark-blue);
            color: var(--c-white);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: var(--c-mid-blue);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--c-mid-blue);
            color: var(--c-white);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: var(--c-dark-blue);
        }
        .chart-container {
            position: relative;
            /* h-72 is 18rem or 288px */
        }
        .placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border-radius: 0.75rem;
            text-align: center;
            padding: 1rem;
            color: #777;
        }
    </style>
</head>
<body onload="initApp()">

    <!-- Header & Navigation -->
    <header class="header sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <h1 class="text-3xl font-bold text-white flex items-center">
                <i class="fas fa-heartbeat text-red-400 mr-3"></i> Wellness Tracker
            </h1>
            <nav class="space-x-4">
                <a href="#" class="nav-link active" data-page="tracker" onclick="showPage('tracker')">Daily Tracker</a>
                <a href="#" class="nav-link" data-page="dashboard" onclick="showPage('dashboard')">Dashboard</a>
                <a href="#" class="nav-link" data-page="settings" onclick="showPage('settings')">Settings</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto pb-12">
        
        <!-- ---------------------------------------------------- -->
        <!-- PAGE 1: DAILY TRACKER VIEW -->
        <!-- ---------------------------------------------------- -->
        <div id="trackerPage" class="space-y-8 p-4 md:p-8">
            <h2 class="text-3xl font-bold text-center text-[var(--c-dark-blue)]">Daily Health Metrics & Logging</h2>
            <p id="userIdDisplay" class="text-sm text-center text-gray-500">Storage Mode: Local Storage</p>

            <!-- Date Selector -->
            <div class="flex justify-center items-center space-x-4">
                <button class="btn-secondary" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
                <input type="date" id="currentDate" class="p-2 border border-gray-300 rounded-lg shadow-inner text-center font-semibold text-lg" onchange="loadDayData()">
                <button class="btn-secondary" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <!-- Metrics Card -->
            <div class="card">
                <h3 class="text-2xl font-semibold mb-6 text-[var(--c-mid-blue)] flex items-center">
                    <i class="fas fa-list-check mr-2"></i> Daily Metrics
                </h3>
                <form id="metricsForm" onsubmit="handleMetricsSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    
                    <div>
                        <label for="steps" class="block text-sm font-medium mb-1">Steps (Count)</label>
                        <input type="number" id="steps" min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--c-mid-blue)]" placeholder="e.g., 8000">
                    </div>
                    
                    <div>
                        <label for="sleep" class="block text-sm font-medium mb-1">Sleep (Hours)</label>
                        <input type="number" id="sleep" min="0" step="0.1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--c-mid-blue)]" placeholder="e.g., 7.5">
                    </div>
                    
                    <div>
                        <label for="rhr" class="block text-sm font-medium mb-1">Resting HR (BPM)</label>
                        <input type="number" id="rhr" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--c-mid-blue)]" placeholder="e.g., 65">
                    </div>

                    <div>
                        <label for="weight" class="block text-sm font-medium mb-1">Weight (Lbs/Kg)</label>
                        <input type="number" id="weight" min="1" step="0.1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--c-mid-blue)]" placeholder="e.g., 180.5">
                    </div>

                    <div class="md:col-span-2 lg:col-span-4 flex justify-center mt-4">
                        <button type="submit" class="btn-primary w-full md:w-auto">Save Daily Metrics</button>
                    </div>
                </form>
            </div>

            <!-- Nutrition Card -->
            <div class="card">
                <h3 class="text-2xl font-semibold mb-6 text-[var(--c-green)] flex items-center">
                    <i class="fas fa-utensils mr-2"></i> Nutrition Log
                </h3>
                
                <!-- Calorie Goal & Progress -->
                <div class="mb-6 flex justify-between items-center bg-gray-50 p-4 rounded-lg border">
                    <div class="text-lg font-medium">Calorie Goal: <span id="calorieGoalDisplay" class="font-bold text-[var(--c-dark-blue)]">2000</span> kcal</div>
                    <div class="text-lg font-medium">Today's Intake: <span id="calorieIntakeDisplay" class="font-bold text-[var(--c-dark-blue)]">0</span> kcal</div>
                    <div class="text-lg font-medium">Remaining: <span id="calorieRemainingDisplay" class="font-bold text-[var(--c-dark-blue)]">2000</span> kcal</div>
                </div>

                <!-- Meal Type Selector & Manual Input -->
                <div class="mb-6">
                    <div class="flex space-x-2 mb-4">
                        <button class="btn-secondary meal-selector active" data-meal="Breakfast" onclick="switchMealType('Breakfast')">Breakfast</button>
                        <button class="btn-secondary meal-selector" data-meal="Lunch" onclick="switchMealType('Lunch')">Lunch</button>
                        <button class="btn-secondary meal-selector" data-meal="Dinner" onclick="switchMealType('Dinner')">Dinner</button>
                        <button class="btn-secondary meal-selector" data-meal="Snack" onclick="switchMealType('Snack')">Snack</button>
                    </div>

                    <form onsubmit="handleManualInput(event)" class="flex space-x-3 items-end">
                        <input type="hidden" id="mealTypeSelectorInput" value="Breakfast">
                        <div class="flex-grow">
                            <label for="foodName" class="block text-sm font-medium mb-1">Food/Meal Name</label>
                            <input type="text" id="foodName" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Oatmeal with berries" required>
                        </div>
                        <div class="w-24">
                            <label for="calories" class="block text-sm font-medium mb-1">Calories</label>
                            <input type="number" id="calories" min="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 350" required>
                        </div>
                        <button type="submit" class="btn-primary self-end whitespace-nowrap"><i class="fas fa-plus mr-1"></i> Add Entry</button>
                    </form>
                </div>

                <!-- Log Display -->
                <div>
                    <h4 class="text-xl font-semibold mb-3">Logged Items for <span id="activeMealTypeDisplay">Breakfast</span></h4>
                    <ul id="nutritionLogList" class="space-y-2">
                        <!-- Nutrition entries will be rendered here -->
                        <li class="text-gray-500 italic">No entries logged for this meal yet.</li>
                    </ul>
                </div>
            </div>

            <!-- Activity Card -->
            <div class="card">
                <h3 class="text-2xl font-semibold mb-6 text-[var(--c-bright-red)] flex items-center">
                    <i class="fas fa-running mr-2"></i> Activity Log
                </h3>
                <form onsubmit="handleActivityInput(event)" class="flex space-x-3 items-end">
                    <div class="w-1/3">
                        <label for="activityType" class="block text-sm font-medium mb-1">Activity Type</label>
                        <select id="activityType" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="Running">Running</option>
                            <option value="Walking">Walking</option>
                            <option value="Weights">Weights</option>
                            <option value="Yoga">Yoga</option>
                            <option value="Cycling">Cycling</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="w-1/3">
                        <label for="activityDuration" class="block text-sm font-medium mb-1">Duration (Minutes)</label>
                        <input type="number" id="activityDuration" min="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., 30" required>
                    </div>
                    <div class="flex-grow">
                        <label for="activityNotes" class="block text-sm font-medium mb-1">Notes (Optional)</label>
                        <input type="text" id="activityNotes" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., park run">
                    </div>
                    <button type="submit" class="btn-primary self-end whitespace-nowrap"><i class="fas fa-plus mr-1"></i> Add Activity</button>
                </form>

                <div class="mt-6">
                    <h4 class="text-xl font-semibold mb-3">Logged Activities</h4>
                    <ul id="activityLogList" class="space-y-2">
                        <!-- Activity entries will be rendered here -->
                        <li class="text-gray-500 italic">No activities logged for today.</li>
                    </ul>
                </div>
            </div>

        </div>

        <!-- ---------------------------------------------------- -->
        <!-- PAGE 2: DASHBOARD SUMMARY VIEW -->
        <!-- ---------------------------------------------------- -->
        <div id="dashboardPage" class="hidden space-y-8 p-4 md:p-8">

            <!-- Dashboard Header with Snap Button -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 class="text-3xl font-bold text-[var(--c-dark-blue)]">Progress Dashboard (Last 7 Days)</h2>
                <button 
                    id="snapDashboardButton" 
                    class="btn-primary flex items-center bg-green-500 hover:bg-green-600 mt-4 sm:mt-0" 
                    onclick="snapDashboard()"
                >
                    <i class="fas fa-camera mr-2"></i> Snap Dashboard
                </button>
            </div>
            
            <!-- Content to be snapped -->
            <div id="dashboardContent" class="space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                    <!-- Weekly Calorie Trend Chart -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--c-dark-blue)] flex items-center"><i class="fas fa-utensils mr-2"></i> Weekly Calorie Trend</h3>
                        <div class="chart-container h-72">
                            <canvas id="weeklyCalorieTrendChart"></canvas>
                            <div id="calorieTrendPlaceholder" class="placeholder hidden">
                                <i class="fas fa-utensils text-4xl mb-2 text-gray-400"></i>
                                <p class="italic text-sm">Log meals over several days to see the trend (Last 7 Days).</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600 text-center">Calories consumed vs. Daily Goal.</div>
                    </div>

                    <!-- Weekly Activity Chart -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--c-dark-blue)] flex items-center"><i class="fas fa-running mr-2"></i> Weekly Activity Minutes</h3>
                        <div class="chart-container h-72">
                            <canvas id="weeklyActivityChart"></canvas>
                            <div id="activityChartPlaceholder" class="placeholder hidden">
                                <i class="fas fa-chart-bar text-4xl mb-2 text-gray-400"></i>
                                <p class="italic text-sm">Log activities to see a weekly breakdown (Last 7 Days).</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600 text-center">Total duration stacked by activity type.</div>
                    </div>
                    
                    <!-- Weight Trend Chart -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--c-dark-blue)] flex items-center"><i class="fas fa-balance-scale mr-2"></i> Weight Trend</h3>
                        <div class="chart-container h-72">
                            <canvas id="weightTrendChart" class=""></canvas>
                            <div id="weightTrendPlaceholder" class="placeholder">
                                <i class="fas fa-chart-line text-4xl mb-2 text-gray-400"></i>
                                <p class="italic text-sm">Log at least two weight entries to see the trend.</p>
                                <p class="text-xs mt-1 text-gray-500">Weight is recorded when saving Daily Metrics.</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600 text-center">Track your weight loss/gain journey over time.</div>
                    </div>
                    
                    <!-- Combined Weekly Health Metrics Trends (NEW POSITION) -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-[var(--c-dark-blue)] flex items-center"><i class="fas fa-chart-area mr-2"></i> Combined Weekly Health Trends</h3>
                        <div id="combinedHealthMetricsChartContainer" class="chart-container h-72">
                            <canvas id="combinedHealthMetricsChart"></canvas>
                            <div id="combinedHealthPlaceholder" class="placeholder hidden h-full">
                                <i class="fas fa-chart-area text-4xl mb-2 text-gray-400"></i>
                                <p class="italic text-sm">Log your daily metrics (Sleep, RHR, Steps) for at least two days to see the combined trend.</p>
                            </div>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2">Metrics are normalized (0-100) for trend comparison.</p>
                    </div>
                    
                </div>

                <!-- Detailed Metrics Table (Not implemented, placeholder) -->
                <div class="card mt-8">
                    <h3 class="text-2xl font-semibold mb-4 text-[var(--c-dark-blue)]"><i class="fas fa-table mr-2"></i> Detailed Daily Data</h3>
                    <p class="text-gray-600 italic">Data is stored in your browser's local storage. Clearing browser data will erase all your logs.</p>
                </div>
            </div>

            <div id="loadingMessage" class="hidden text-center text-lg text-gray-500 mt-4">
                <i class="fas fa-spinner fa-spin mr-2"></i> Generating image...
            </div>
        </div>

        <!-- ---------------------------------------------------- -->
        <!-- PAGE 3: SETTINGS VIEW -->
        <!-- ---------------------------------------------------- -->
        <div id="settingsPage" class="hidden space-y-8 p-4 md:p-8">
            <h2 class="text-3xl font-bold text-center text-[var(--c-dark-blue)]">Application Settings</h2>
            
            <!-- Goal Setting Card -->
            <div class="card max-w-lg mx-auto">
                <h3 class="text-2xl font-semibold mb-4 text-[var(--c-mid-blue)]"><i class="fas fa-bullseye mr-2"></i> Goal Settings</h3>
                <form onsubmit="setCalorieGoal(event)" class="space-y-4">
                    <div>
                        <label for="calorieGoalInput" class="block text-sm font-medium mb-1">Daily Calorie Goal (kcal)</label>
                        <input type="number" id="calorieGoalInput" min="1000" step="50" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">Update Goal</button>
                </form>
            </div>

            <!-- Local Storage Info Card -->
            <div class="card max-w-lg mx-auto">
                <h3 class="text-2xl font-semibold mb-4 text-[var(--c-dark-blue)]"><i class="fas fa-database mr-2"></i> Storage Information</h3>
                <p class="text-gray-700">All application data is currently stored locally in your browser's Local Storage.</p>
                <p class="text-sm text-gray-500 mt-2">
                    Storage Key Prefix: <span class="font-mono text-xs text-[var(--c-dark-blue)]">wellnessTracker_</span><br>
                    Note: Data is private to this browser.
                </p>
                <button onclick="clearAllData()" class="mt-4 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-150 text-sm w-full">
                    <i class="fas fa-trash mr-2"></i> Clear All Local Data
                </button>
            </div>

        </div>

    </main>

    <script>
        // --- Configuration & Global State ---
        let currentDate = new Date();
        let dailyMetrics = {}; // Stores metrics for the current day
        let activityLog = []; // Stores activity entries for the current day
        let nutritionLog = []; // Stores nutrition entries for the current day
        let calorieGoal = 2000;
        let activeMealType = 'Breakfast';

        // Chart instances
        let calorieTrendChart = null;
        let activityChart = null;
        let weightTrendChart = null;
        let combinedHealthMetricsChart = null;

        const STORAGE_PREFIX = 'wellnessTracker_';
        const STORAGE_KEY_SETTINGS = STORAGE_PREFIX + 'settings';
        const STORAGE_KEY_NUTRITION = STORAGE_PREFIX + 'nutritionLog'; // Stores ALL nutrition entries
        const STORAGE_PREFIX_METRICS = STORAGE_PREFIX + 'dailyMetrics_'; // Metric key: dailyMetrics_YYYY-MM-DD

        // --- Local Storage Helper Functions ---

        const getData = (key, defaultValue = null) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error("Error reading localStorage key:", key, e);
                return defaultValue;
            }
        };

        const setData = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error("Error writing to localStorage key:", key, e);
            }
        };

        const getMetricKey = (dateString) => STORAGE_PREFIX_METRICS + dateString;

        // --- Core Application Logic ---

        window.initApp = () => {
            // Set date to today and load data
            const today = formatDate(new Date());
            document.getElementById('currentDate').value = today;
            currentDate = dateFromInput(today);
            
            loadSettings();
            loadDayData();

            // Set up initial navigation page
            showPage('tracker');
        };

        window.loadSettings = () => {
            const settings = getData(STORAGE_KEY_SETTINGS, { calorieGoal: 2000 });
            calorieGoal = settings.calorieGoal;
            document.getElementById('calorieGoalDisplay').textContent = calorieGoal;
            document.getElementById('calorieGoalInput').value = calorieGoal;
            // Update remaining calories immediately
            updateNutritionCalorieSummary();
        };

        window.setCalorieGoal = (event) => {
            event.preventDefault();
            const newGoal = parseInt(document.getElementById('calorieGoalInput').value, 10);
            if (newGoal >= 1000) {
                calorieGoal = newGoal;
                setData(STORAGE_KEY_SETTINGS, { calorieGoal: newGoal });
                loadSettings(); // Reload and update UI
            } else {
                console.error("Calorie goal must be at least 1000.");
            }
            // Simple visual feedback (no alerts allowed)
            const btn = event.submitter;
            btn.textContent = 'Goal Updated!';
            setTimeout(() => { btn.textContent = 'Update Goal'; }, 1500);
        };

        window.clearAllData = () => {
             // Using prompt instead of confirm/alert
             const result = window.prompt("WARNING: This will delete ALL your data stored in this browser. Type 'DELETE DATA' to confirm:");
             if (result === 'DELETE DATA') {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(STORAGE_PREFIX)) { // Added check for null key
                        localStorage.removeItem(key);
                    }
                }
                // Reset state and reload UI
                nutritionLog = [];
                dailyMetrics = {};
                activityLog = [];
                initApp(); // Re-initialize to default state
                // Since alerts are disallowed, we use console feedback and UI update
                console.log('All wellness data has been cleared from local storage.');
                
                const deleteBtn = document.querySelector('#settingsPage button[onclick="clearAllData()"]');
                deleteBtn.textContent = 'Data Cleared!';
                deleteBtn.classList.add('bg-green-500');
                deleteBtn.classList.remove('bg-red-500');
                setTimeout(() => { 
                    deleteBtn.textContent = 'Clear All Local Data'; 
                    deleteBtn.classList.add('bg-red-500');
                    deleteBtn.classList.remove('bg-green-500');
                }, 2000);

             } else {
                 // Using an invisible message box for feedback since alerts are disallowed
                 console.log("Data clearing cancelled.");
             }
        }

        // --- Daily Data Loading and Saving ---

        const getDailyMetricsData = (dateString) => {
            return getData(getMetricKey(dateString), {
                steps: null,
                sleep: null,
                rhr: null,
                weight: null,
                activities: []
            });
        };

        const getAllNutritionData = () => {
            return getData(STORAGE_KEY_NUTRITION, []);
        };

        window.loadDayData = () => {
            const dateString = document.getElementById('currentDate').value;
            if (!dateString) return; // Guard against empty date on load

            currentDate = dateFromInput(dateString);

            // 1. Load Daily Metrics & Activity
            const data = getDailyMetricsData(dateString);
            dailyMetrics = data;
            activityLog = data.activities || [];
            updateMetricsUI();
            updateActivityUI();

            // 2. Load Nutrition Log
            const allNutritionEntries = getAllNutritionData();
            nutritionLog = allNutritionEntries
                .filter(entry => entry.date === dateString)
                .sort((a, b) => a.timestamp - b.timestamp);
            updateNutritionUI(); 
        };

        window.handleMetricsSubmit = (event) => {
            event.preventDefault();
            const dateString = formatDate(currentDate);

            // Collect data from form
            const stepsValue = document.getElementById('steps').value;
            const sleepValue = document.getElementById('sleep').value;
            const rhrValue = document.getElementById('rhr').value;
            const weightValue = document.getElementById('weight').value;
            
            const metrics = {
                steps: stepsValue ? parseInt(stepsValue, 10) : null,
                sleep: sleepValue ? parseFloat(sleepValue) : null,
                rhr: rhrValue ? parseInt(rhrValue, 10) : null,
                weight: weightValue ? parseFloat(weightValue) : null,
                // Preserve existing activities if any
                activities: dailyMetrics.activities || [] 
            };
            
            // Save to Local Storage
            setData(getMetricKey(dateString), metrics);
            dailyMetrics = metrics; // Update local state

            // Simple visual feedback
            const btn = event.submitter;
            btn.textContent = 'Saved!';
            setTimeout(() => { btn.textContent = 'Save Daily Metrics'; }, 1500);
        };

        window.handleManualInput = (event) => {
            event.preventDefault();
            const dateString = formatDate(currentDate);
            const foodName = document.getElementById('foodName').value.trim();
            const calories = document.getElementById('calories').value;
            const mealType = document.getElementById('mealTypeSelectorInput').value;
            
            if (foodName && calories) {
                const newEntry = {
                    id: Date.now(), // Simple unique ID
                    date: dateString,
                    meal: mealType,
                    food: foodName,
                    calories: parseInt(calories, 10),
                    timestamp: Date.now()
                };

                // Load all, add new, save all
                const allNutritionEntries = getAllNutritionData();
                allNutritionEntries.push(newEntry);
                setData(STORAGE_KEY_NUTRITION, allNutritionEntries);

                // Reload current day's data
                loadDayData();

                // Clear form
                document.getElementById('foodName').value = '';
                document.getElementById('calories').value = '';
            }
        };

        window.handleActivityInput = (event) => {
            event.preventDefault();
            const dateString = formatDate(currentDate);
            const activityType = document.getElementById('activityType').value;
            const duration = document.getElementById('activityDuration').value;
            const notes = document.getElementById('activityNotes').value.trim();

            if (duration && parseInt(duration, 10) > 0) {
                const newActivity = {
                    id: Date.now(),
                    type: activityType,
                    duration: parseInt(duration, 10),
                    notes: notes,
                    timestamp: Date.now()
                };

                // Get today's metrics, add activity, save back
                const metricsData = getDailyMetricsData(dateString);
                metricsData.activities = metricsData.activities || [];
                metricsData.activities.push(newActivity);

                setData(getMetricKey(dateString), metricsData);

                // Reload current day's data
                loadDayData();

                // Clear form
                document.getElementById('activityDuration').value = '';
                document.getElementById('activityNotes').value = '';
            }
        };

        window.removeNutritionEntry = (entryId) => {
            const allNutritionEntries = getAllNutritionData();
            const updatedEntries = allNutritionEntries.filter(entry => entry.id !== entryId);
            setData(STORAGE_KEY_NUTRITION, updatedEntries);
            loadDayData();
        };

        window.removeActivityEntry = (activityId) => {
            const dateString = formatDate(currentDate);
            const metricsData = getDailyMetricsData(dateString);
            metricsData.activities = metricsData.activities.filter(activity => activity.id !== activityId);
            
            setData(getMetricKey(dateString), metricsData);
            loadDayData();
        };

        // --- UI Update Functions ---

        const updateMetricsUI = () => {
            document.getElementById('steps').value = dailyMetrics.steps ?? '';
            document.getElementById('sleep').value = dailyMetrics.sleep ?? '';
            document.getElementById('rhr').value = dailyMetrics.rhr ?? '';
            document.getElementById('weight').value = dailyMetrics.weight ?? '';
        };

        const updateNutritionUI = () => {
            const list = document.getElementById('nutritionLogList');
            list.innerHTML = '';
            
            // Filter entries for the currently active meal type
            const filteredEntries = nutritionLog.filter(entry => entry.meal === activeMealType);
            
            if (filteredEntries.length === 0) {
                list.innerHTML = '<li class="text-gray-500 italic">No entries logged for this meal yet.</li>';
            } else {
                filteredEntries.forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200';
                    li.innerHTML = `
                        <div class="flex-grow">
                            <span class="font-medium">${entry.food}</span>
                            <span class="text-sm text-gray-500 ml-2">(${entry.meal})</span>
                        </div>
                        <div class="font-bold text-[var(--c-green)]">${entry.calories} kcal</div>
                        <button onclick="removeNutritionEntry(${entry.id})" class="text-gray-400 hover:text-[var(--c-bright-red)] ml-4 transition duration-150">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            }
            updateNutritionCalorieSummary();
        };

        const updateNutritionCalorieSummary = () => {
            const totalIntake = nutritionLog.reduce((sum, entry) => sum + entry.calories, 0);
            const remaining = calorieGoal - totalIntake;

            document.getElementById('calorieIntakeDisplay').textContent = totalIntake;
            document.getElementById('calorieGoalDisplay').textContent = calorieGoal;
            
            const remainingEl = document.getElementById('calorieRemainingDisplay');
            remainingEl.textContent = remaining;

            if (remaining < 0) {
                remainingEl.classList.add('text-[var(--c-bright-red)]');
                remainingEl.classList.remove('text-[var(--c-dark-blue)]');
            } else {
                remainingEl.classList.remove('text-[var(--c-bright-red)]');
                remainingEl.classList.add('text-[var(--c-dark-blue)]');
            }
        };

        const updateActivityUI = () => {
            const list = document.getElementById('activityLogList');
            list.innerHTML = '';

            if (activityLog.length === 0) {
                list.innerHTML = '<li class="text-gray-500 italic">No activities logged for today.</li>';
            } else {
                activityLog.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200';
                    li.innerHTML = `
                        <div class="flex-grow">
                            <span class="font-bold text-[var(--c-bright-red)]">${activity.type}</span> 
                            <span class="text-sm text-gray-700 ml-2">${activity.notes ? `(${activity.notes})` : ''}</span>
                        </div>
                        <div class="font-medium text-[var(--c-dark-blue)]">${activity.duration} min</div>
                        <button onclick="removeActivityEntry(${activity.id})" class="text-gray-400 hover:text-[var(--c-bright-red)] ml-4 transition duration-150">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            }
        };

        // --- Navigation and Date Helpers ---

        window.showPage = (pageId) => {
            document.querySelectorAll('div[id$="Page"]').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId + 'Page').classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                }
            });

            // If navigating to dashboard, refresh charts
            if (pageId === 'dashboard') {
                renderDashboardCharts();
            }
        };

        window.switchMealType = (mealType) => {
            activeMealType = mealType;
            document.getElementById('mealTypeSelectorInput').value = mealType;
            document.getElementById('activeMealTypeDisplay').textContent = mealType;
            
            document.querySelectorAll('.meal-selector').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.meal === mealType) {
                    btn.classList.add('active');
                }
            });
            updateNutritionUI();
        };

        const formatDate = (date) => {
            // Ensure we use YYYY-MM-DD format for input compatibility
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const dateFromInput = (dateString) => {
            const parts = dateString.split('-');
            // Use UTC to prevent timezone shifts from changing the day, but JS Date objects
            // are generally fine for simple YYYY-MM-DD input date handling.
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            date.setHours(0, 0, 0, 0); // Normalize to start of day
            return date;
        }

        window.changeDate = (days) => {
            const input = document.getElementById('currentDate');
            let currentDay = dateFromInput(input.value);
            
            currentDay.setDate(currentDay.getDate() + days);
            
            input.value = formatDate(currentDay);
            currentDate = currentDay;
            loadDayData();
        };

        // --- Dashboard & Charting Logic ---

        // Helper to get the date N days ago as a Date object (midnight UTC)
        const getDateNDaysAgo = (n) => {
            const date = new Date();
            date.setHours(0, 0, 0, 0); // Start of day
            date.setDate(date.getDate() - n);
            return date;
        };
        
        // Helper to get all data for the last N days
        const getRecentData = (days = 7) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dataMap = {};
            const labels = [];
            
            // Fetch all global nutrition data once
            const allNutritionEntries = getAllNutritionData();

            for (let i = days - 1; i >= 0; i--) {
                const dayDate = getDateNDaysAgo(i);
                const dateString = formatDate(dayDate);
                // Use a short label for chart X-axis (e.g., M/D)
                labels.push(`${dayDate.getMonth() + 1}/${dayDate.getDate()}`); 

                const metrics = getDailyMetricsData(dateString);
                
                // Calculate total calories for the day
                const dailyNutrition = allNutritionEntries.filter(entry => entry.date === dateString);
                const totalCalories = dailyNutrition.reduce((sum, entry) => sum + entry.calories, 0);

                dataMap[dateString] = {
                    date: dateString,
                    metrics: metrics,
                    totalCalories: totalCalories
                };
            }
            return { dataMap, labels };
        };

        window.renderDashboardCharts = () => {
            const { dataMap, labels } = getRecentData(7);
            const allData = Object.values(dataMap);

            // Fetch current settings for the goal
            loadSettings();

            renderCalorieTrendChart(labels, allData);
            renderActivityChart(labels, allData);
            renderWeightTrendChart(labels, allData);
            renderCombinedHealthMetricsChart(labels, allData);
        };

        // ----------------------------------------------------
        // Chart 1: Weekly Calorie Trend
        // ----------------------------------------------------
        const renderCalorieTrendChart = (labels, allData) => {
            const calories = allData.map(d => d.totalCalories);
            const goals = allData.map(() => calorieGoal);
            
            const hasData = calories.some(c => c > 0);
            document.getElementById('calorieTrendPlaceholder').classList.toggle('hidden', hasData);

            if (!hasData) {
                if (calorieTrendChart) calorieTrendChart.destroy();
                calorieTrendChart = null;
                return;
            }

            const ctx = document.getElementById('weeklyCalorieTrendChart').getContext('2d');
            if (calorieTrendChart) calorieTrendChart.destroy();

            calorieTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Calories Consumed',
                            data: calories,
                            backgroundColor: 'rgba(61, 204, 123, 0.8)', // var(--c-green)
                            borderColor: 'rgba(61, 204, 123, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'Goal',
                            data: goals,
                            borderColor: 'rgba(10, 36, 99, 1)', // var(--c-dark-blue)
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Calories (kcal)' }
                        },
                        x: {
                            title: { display: true, text: 'Date (M/D)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        };

        // ----------------------------------------------------
        // Chart 2: Weekly Activity Minutes
        // ----------------------------------------------------
        const renderActivityChart = (labels, allData) => {
            // Aggregate minutes by date and activity type
            const aggregatedData = {};
            const activityTypes = new Set();
            
            allData.forEach(day => {
                day.metrics.activities.forEach(activity => {
                    const type = activity.type;
                    activityTypes.add(type);
                    if (!aggregatedData[type]) {
                        // Initialize array for this activity type with zeros
                        aggregatedData[type] = new Array(labels.length).fill(0);
                    }
                    
                    // The label is in M/D format, need to find the index based on position
                    const dayDate = new Date(day.date);
                    const shortDate = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
                    const index = labels.indexOf(shortDate);

                    if (index !== -1) {
                        aggregatedData[type][index] += activity.duration;
                    }
                });
            });

            const hasData = activityTypes.size > 0;
            document.getElementById('activityChartPlaceholder').classList.toggle('hidden', hasData);

            if (!hasData) {
                if (activityChart) activityChart.destroy();
                activityChart = null;
                return;
            }

            const activityColors = {
                Running: 'rgba(216, 49, 91, 0.7)', // Bright Red
                Walking: 'rgba(62, 146, 204, 0.7)', // Mid Blue
                Weights: 'rgba(10, 36, 99, 0.7)', // Dark Blue
                Yoga: 'rgba(61, 204, 123, 0.7)', // Green
                Cycling: 'rgba(255, 159, 64, 0.7)',
                Other: 'rgba(153, 102, 255, 0.7)'
            };

            const datasets = Array.from(activityTypes).map(type => ({
                label: type,
                data: aggregatedData[type],
                backgroundColor: activityColors[type] || 'rgba(128, 128, 128, 0.7)',
                stack: 'Stack 1' // Stack the bars
            }));

            const ctx = document.getElementById('weeklyActivityChart').getContext('2d');
            if (activityChart) activityChart.destroy();

            activityChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Date (M/D)' } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Minutes' } }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        };
        
        // ----------------------------------------------------
        // Chart 3: Weight Trend
        // ----------------------------------------------------
        const renderWeightTrendChart = (labels, allData) => {
            // Filter out null weight values and corresponding labels
            const trackedData = allData.filter(d => d.metrics.weight !== null);
            const weights = trackedData.map(d => d.metrics.weight);
            const weightLabels = trackedData.map(d => {
                const date = new Date(d.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const hasData = weights.length >= 2;
            document.getElementById('weightTrendPlaceholder').classList.toggle('hidden', hasData);

            if (!hasData) {
                if (weightTrendChart) weightTrendChart.destroy();
                weightTrendChart = null;
                return;
            }

            const ctx = document.getElementById('weightTrendChart').getContext('2d');
            if (weightTrendChart) weightTrendChart.destroy();

            weightTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weightLabels,
                    datasets: [{
                        label: 'Weight',
                        data: weights,
                        borderColor: 'rgba(62, 146, 204, 1)', // Mid Blue
                        backgroundColor: 'rgba(62, 146, 204, 0.2)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointBackgroundColor: 'rgba(10, 36, 99, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Weight (Lbs/Kg)' },
                            reverse: false // Typically, weight loss is down
                        },
                        x: {
                            title: { display: true, text: 'Date (M/D)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        };
        
        // ----------------------------------------------------
        // Chart 4: Combined Health Metrics
        // ----------------------------------------------------
        const renderCombinedHealthMetricsChart = (labels, allData) => {
            
            // --- Normalization Logic (0-100 scale) ---
            const stepsValues = allData.map(d => d.metrics.steps).filter(v => v !== null);
            const sleepValues = allData.map(d => d.metrics.sleep).filter(v => v !== null);
            const rhrValues = allData.map(d => d.metrics.rhr).filter(v => v !== null);

            const hasData = stepsValues.length >= 2 || sleepValues.length >= 2 || rhrValues.length >= 2;
            document.getElementById('combinedHealthPlaceholder').classList.toggle('hidden', hasData);

            if (!hasData) {
                if (combinedHealthMetricsChart) combinedHealthMetricsChart.destroy();
                combinedHealthMetricsChart = null;
                return;
            }
            
            // Helper to determine min/max safely
            const getMinMax = (values) => ({
                min: values.length > 0 ? Math.min(...values) : 0,
                max: values.length > 0 ? Math.max(...values) : 1
            });
            
            const minMax = {
                steps: getMinMax(stepsValues),
                sleep: getMinMax(sleepValues),
                rhr: getMinMax(rhrValues)
            };

            const normalize = (value, min, max, isReverse = false) => {
                if (value === null) return null;
                if (min === max) return 50; // Use 50 if no range
                
                const normalized = 100 * (value - min) / (max - min);
                return isReverse ? 100 - normalized : normalized;
            };
            
            const normalizedSteps = allData.map(d => 
                normalize(d.metrics.steps, minMax.steps.min, minMax.steps.max, false)
            );
            const normalizedSleep = allData.map(d => 
                normalize(d.metrics.sleep, minMax.sleep.min, minMax.sleep.max, false)
            );
            // RHR is better when lower, so we reverse the normalization
            const normalizedRHR = allData.map(d => 
                normalize(d.metrics.rhr, minMax.rhr.min, minMax.rhr.max, true) 
            );

            const ctx = document.getElementById('combinedHealthMetricsChart').getContext('2d');
            if (combinedHealthMetricsChart) combinedHealthMetricsChart.destroy();

            combinedHealthMetricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Steps (Normalized)',
                            data: normalizedSteps,
                            borderColor: 'rgba(62, 146, 204, 1)', // Mid Blue
                            backgroundColor: 'rgba(62, 146, 204, 0.2)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Sleep (Normalized)',
                            data: normalizedSleep,
                            borderColor: 'rgba(61, 204, 123, 1)', // Green
                            backgroundColor: 'rgba(61, 204, 123, 0.2)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'RHR (Normalized, Lower is Better)',
                            data: normalizedRHR,
                            borderColor: 'rgba(216, 49, 91, 1)', // Bright Red
                            backgroundColor: 'rgba(216, 49, 91, 0.2)',
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Normalized Score (0-100)' }
                        },
                        x: {
                            title: { display: true, text: 'Date (M/D)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        };
        
        // ----------------------------------------------------
        // SNAPSHOT LOGIC
        // ----------------------------------------------------
        window.snapDashboard = async () => {
            const element = document.getElementById('dashboardContent');
            const button = document.getElementById('snapDashboardButton');
            const loading = document.getElementById('loadingMessage');

            // 1. Show Loading State
            button.disabled = true;
            loading.classList.remove('hidden');
            const originalButtonText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-camera mr-2"></i> Capturing...';
            
            // Wait for a moment to ensure loading spinner is painted
            await new Promise(resolve => setTimeout(resolve, 50)); 

            try {
                // 2. Capture the HTML element
                const canvas = await html2canvas(element, {
                    scale: 2, // Capture at a higher resolution for better quality
                    useCORS: true,
                    // Ignore the loading message itself
                    ignoreElements: (el) => el.id === 'loadingMessage' || el.id === 'snapDashboardButton'
                });

                // 3. Convert Canvas to Image Data
                const dataUrl = canvas.toDataURL('image/png');

                // 4. Trigger Download
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `WellnessDashboard_${formatDate(new Date())}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // 5. Provide feedback
                button.innerHTML = '<i class="fas fa-check mr-2"></i> Saved!';
                button.classList.add('bg-blue-500');
                button.classList.remove('bg-green-500');

            } catch (error) {
                console.error("Error snapping dashboard:", error);
                // Handle error without alert
                button.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Error!';
                button.classList.add('bg-red-500');
                button.classList.remove('bg-green-500');
            } finally {
                // 6. Reset state
                loading.classList.add('hidden');
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalButtonText;
                    button.classList.remove('bg-blue-500', 'bg-red-500');
                    button.classList.add('bg-green-500');
                }, 2000);
            }
        };

        // Initialize the app when the body loads
        // initApp() is now called from the <body> onload attribute
    </script>
</body>
</html>
